<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>超星图片上传工具</title>
</head>
<body>
    <h1>超星图片上传工具</h1>
    <input type="file" id="fileInput" />
    <button id="uploadButton">上传图片</button>
    <p id="status"></p>

    <script>
        // 获取上传参数
        async function getUploadParams() {
            const response = await fetch("https://mooc1.chaoxing.com/mooc-ans/coursestar", {
                method: "GET",
                credentials: "include",
            });
            const text = await response.text();

            const currentTime = text.match(/window\["currentTime"\] = "(.*?)";/)[1];
            const uploadEnc = text.match(/window\["uploadEnc"\] = "(.*?)";/)[1];

            return { currentTime, uploadEnc };
        }

        // 上传文件
        async function uploadFile(file) {
            // 替换为你的 Cloudflare Workers URL
            const workerUrl = "https://chaoxing-upload.a212883851.workers.dev/";

            const { currentTime, uploadEnc } = await getUploadParams();
            const proxyUrl = `${workerUrl}?uid=&enc2=${uploadEnc}&t=${currentTime}&encode=utf-8`;

            const formData = new FormData();
            formData.append("upfile", file);

            const response = await fetch(proxyUrl, {
                method: "POST",
                body: formData,
            });

            if (response.ok) {
                return await response.json();
            } else {
                throw new Error(`上传失败: ${response.statusText}`);
            }
        }

        // 页面交互
        document.getElementById("uploadButton").addEventListener("click", async () => {
            const fileInput = document.getElementById("fileInput");
            const status = document.getElementById("status");

            if (!fileInput.files.length) {
                status.textContent = "请先选择文件！";
                return;
            }

            const file = fileInput.files[0];
            status.textContent = "正在上传，请稍后...";

            try {
                const result = await uploadFile(file);
                status.textContent = `上传成功！文件地址: ${result.url}`;
            } catch (error) {
                status.textContent = `上传失败：${error.message}`;
            }
        });
    </script>
</body>
</html>
